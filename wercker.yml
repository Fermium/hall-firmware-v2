box: ubuntu:xenial
build:
  steps:
    - install-packages:
        packages: gcc-avr avr-libc make git doxygen
    - script:
        name: initialize git submodules
        code: git submodule update --init --recursive
    - script:
        name: Compile
        code: make
    - script:
        name: Build html docs
        code: make docs
deploy:
  steps:
    - install-packages:
        packages: git wget python
    - edgecaseadmin/install-aws-cli:
        key: $AWS_ACCESS_KEY_ID
        secret: $AWS_SECRET_ACCESS_KEY
    - script:
        name: "Push firmware build to S3 by project name, branch, hash"
        code: |
            md5sum main.* > checksums.md5
            aws s3 cp main.* s3://fermiumlabs-firmware-builds/$WERCKER_GIT_REPOSITORY/$WERCKER_GIT_BRANCH/$WERCKER_GIT_COMMIT/
            aws s3 cp checksums.md5 s3://fermiumlabs-firmware-builds/$WERCKER_GIT_REPOSITORY/$WERCKER_GIT_BRANCH/$WERCKER_GIT_COMMIT/
deploy-docs:
  box: fermiumlabs/latex-docker
  steps:
    - script:
        name: "Build docs"
        code: |
            make docs
            make docs_pdf
    - install-packages:
        packages: git wget python
    - edgecaseadmin/install-aws-cli:
        key: $AWS_ACCESS_KEY_ID
        secret: $AWS_SECRET_ACCESS_KEY
    - script:
        name: "Push firmware build to S3 by project name, branch, hash"
        code: |
            md5sum main.* > checksums.md5
            aws s3 sync --exclude=* --include=main.* s3://fermiumlabs-firmware-builds/$WERCKER_GIT_REPOSITORY/$WERCKER_GIT_BRANCH/
            aws s3 cp checksums.md5 s3://fermiumlabs-firmware-builds/$WERCKER_GIT_REPOSITORY/$WERCKER_GIT_BRANCH/
